generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// *
/// * USUARIO
model Usuario {
  id                Int                @id @default(autoincrement())
  nombre            String
  correo            String             @unique
  createdAt         DateTime           @default(now())
  password          String
  compras           Compra[]
  movimientosCuenta MovimientoCuenta[]
  ventas            Venta[]
}

/// *
/// * PERSONA — UNIFICACIÓN (Cliente y Proveedor)
model Persona {
  id        Int         @id @default(autoincrement())
  cedula    String      @unique
  nombre    String
  sexo      String?
  celular   String?
  correo    String?
  tipo      TipoPersona
  compras   Compra[]    @relation("ProveedorCompras")
  productos Producto[]
  ventas    Venta[]     @relation("ClienteVentas")
}

/// *
/// * PRODUCTOS — INVENTARIO
model Producto {
  id             Int                    @id @default(autoincrement())
  nombre         String
  descripcion    String?
  precio_compra  Float
  precio_venta   Float
  stock          Int                    @default(0)
  fecha_creado   DateTime               @default(now())
  estado         EstadoInventario       @default(EN_USO)
  proveedorId    Int?
  compraDetalles CompraDetalle[]
  movimientos    MovimientoInventario[]
  proveedor      Persona?               @relation(fields: [proveedorId], references: [id])
  ventaDetalles  VentaDetalle[]
}

/// *
/// * COMPRA (CABECERA)
model Compra {
  id               Int                @id @default(autoincrement())
  num_factura      String
  total            Float
  base             Float
  creadoEn         DateTime           @default(now())
  estado           EstadoCompra       @default(PENDIENTE)
  fecha_emision    DateTime           @default(now())
  forma_pago       FormaPago
  iva              Float
  iva_tipo         IvaTipo
  num_autorizacion String
  proveedorId      Int
  usuarioId        Int
  proveedor        Persona            @relation("ProveedorCompras", fields: [proveedorId], references: [id])
  usuario          Usuario            @relation(fields: [usuarioId], references: [id])
  detalles         CompraDetalle[]
  pagos            MovimientoCuenta[]
}

/// *
/// * DETALLE DE COMPRA
model CompraDetalle {
  id          Int      @id @default(autoincrement())
  cantidad    Int
  precio_unit Float
  subtotal    Float
  compraId    Int
  productoId  Int
  compra      Compra   @relation(fields: [compraId], references: [id], onDelete: Cascade)
  producto    Producto @relation(fields: [productoId], references: [id])
}

/// *
/// * VENTA (CABECERA)
model Venta {
  id               Int                @id @default(autoincrement())
  num_factura      String
  total            Float
  base             Float
  clienteId        Int
  creadoEn         DateTime           @default(now())
  estado           EstadoVenta        @default(PENDIENTE)
  fecha_emision    DateTime           @default(now())
  forma_pago       FormaPago
  iva              Float
  iva_tipo         IvaTipo
  num_autorizacion String
  usuarioId        Int
  cobros           MovimientoCuenta[]
  cliente          Persona            @relation("ClienteVentas", fields: [clienteId], references: [id])
  usuario          Usuario            @relation(fields: [usuarioId], references: [id])
  detalles         VentaDetalle[]
}

/// *
/// * DETALLE DE VENTA
model VentaDetalle {
  id          Int      @id @default(autoincrement())
  cantidad    Int
  precio_unit Float
  subtotal    Float
  productoId  Int
  ventaId     Int
  producto    Producto @relation(fields: [productoId], references: [id])
  venta       Venta    @relation(fields: [ventaId], references: [id], onDelete: Cascade)
}

/// *
/// * KARDEX — MOVIMIENTOS DE INVENTARIO
model MovimientoInventario {
  id             Int      @id @default(autoincrement())
  tipo           String
  cantidad       Int
  costo_unitario Float
  costo_total    Float
  stock_antes    Int
  stock_despues  Int
  fecha          DateTime @default(now())
  productoId     Int
  referenciaId   Int?
  referenciaTipo String?
  producto       Producto @relation(fields: [productoId], references: [id])
}

/// *
/// * CUENTA (BANCO / CAJA CHICA)
model Cuenta {
  id          Int                @id @default(autoincrement())
  nombre      String
  tipo        TipoCuenta
  saldo       Float              @default(0)
  creadoEn    DateTime           @default(now())
  bancoNombre String?
  bancoTipo   BancoTipo?
  movimientos MovimientoCuenta[]
}

/// *
/// * MOVIMIENTOS DE CUENTA
model MovimientoCuenta {
  id         Int      @id @default(autoincrement())
  cuentaId   Int
  tipo       String
  monto      Float
  fecha      DateTime @default(now())
  referencia String?
  compraId   Int?
  ventaId    Int?
  usuarioId  Int?
  compra     Compra?  @relation(fields: [compraId], references: [id])
  cuenta     Cuenta   @relation(fields: [cuentaId], references: [id])
  usuario    Usuario? @relation(fields: [usuarioId], references: [id])
  venta      Venta?   @relation(fields: [ventaId], references: [id])
}

enum TipoPersona {
  CLIENTE
  PROVEEDOR
}

enum IvaTipo {
  CERO
  QUINCE
  NO_OBJETO
}

enum FormaPago {
  CAJA_CHICA
  BANCO
}

enum EstadoCompra {
  PAGADA
  PENDIENTE
}

enum EstadoVenta {
  COBRADA
  PENDIENTE
}

enum EstadoInventario {
  EN_USO
  DANADO
}

enum BancoTipo {
  AHORRO
  CORRIENTE
}

enum TipoCuenta {
  BANCO
  CAJA_CHICA
}
